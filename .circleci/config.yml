version: 2.1

orbs:
  codecov: codecov/codecov@1.0.5


jobs:

  build-python:
    parameters:
      python-version:
        type: string
    docker:
      - image: cimg/python:<< parameters.python-version >>
    steps:
      - checkout
      - run: sudo make deps-ubuntu
      - when:
          condition:
            equal: [ '3.6', << parameters.python-version >> ]
          steps:
            # speed-up build time for end-of-life Python by holding at latest binary:
            - run: pip install --prefer-binary -U opencv-python-headless numpy
      - run: make install
      # PPA tessdata prefix (= ocrd_tesserocr moduledir) is owned by root
      - run: sudo chmod go+w `dpkg-query -L tesseract-ocr-eng | sed -n s,/eng.traineddata,,p`
      - run: ocrd resmgr download ocrd-tesserocr-recognize deu.traineddata
      - run: ocrd resmgr download ocrd-tesserocr-recognize Fraktur.traineddata
      - run: make test-cli
      - run: make coverage
      - codecov/upload

workflows:
  build:
    jobs:
      - build-python:
          matrix:
            parameters:
              python-version: ['3.6', '3.7', '3.8', '3.9', '3.10']
