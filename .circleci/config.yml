version: 2.1

orbs:
  codecov: codecov/codecov@1.0.5

commands:
  install-test-coverage:
    steps:
      - checkout
      - run: sudo make deps-ubuntu
      - when:
          equal: [ 'cimg/python:3.6', << parameters.python-image >> ]
          steps:
            # speed-up build time for end-of-life Python by holding at latest binary:
            - run: pip install --prefer-binary -U opencv-python-headless numpy
      - run: make install
      - run: ocrd resmgr download ocrd-tesserocr-recognize deu.traineddata
      - run: make test-cli
      - run: make coverage
      - codecov/upload

jobs:

  build-python:
    parameters:
      python-image:
        type: string
    docker:
      - image: << parameters.python-image >>
    steps:
      - install-test-coverage

workflows:
  build:
    jobs:
      - build-python:
          matrix:
            parameters:
              python-image:
                - 'cimg/python:3.6'
                - 'cimg/python:3.7'
                - 'cimg/python:3.8'
                - 'cimg/python:3.9'
                - 'cimg/python:3.10'
